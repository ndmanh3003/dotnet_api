<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Google Login</title>
  </head>
  <body
    style="
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    "
  >
    <h2>Test Google Login vá»›i backend .NET</h2>
    <button
      id="login-btn"
      style="padding: 10px 20px; font-size: 16px; cursor: pointer"
    >
      ğŸ”‘ ÄÄƒng nháº­p báº±ng Google
    </button>
    <p id="status" style="margin-top: 20px; color: gray"></p>

    <script>
      const apiBase = 'http://localhost:5086'
      const googleClientId =
        '661467940120-t38ofebtt1k63g2kc0elq2krovtmm622.apps.googleusercontent.com'
      const frontendBaseUrl = window.location.origin
      const redirectPath = window.location.pathname // Chá»‰ láº¥y path, khÃ´ng láº¥y origin
      const fullRedirectUri = frontendBaseUrl + redirectPath // DÃ¹ng cho Google OAuth

      // Khi báº¥m nÃºt login
      document.getElementById('login-btn').addEventListener('click', () => {
        // Táº¡o Google OAuth URL
        const authUrl = new URL('https://accounts.google.com/o/oauth2/v2/auth')
        authUrl.searchParams.set('client_id', googleClientId)
        authUrl.searchParams.set('redirect_uri', fullRedirectUri)
        authUrl.searchParams.set('response_type', 'code')
        authUrl.searchParams.set('scope', 'openid email profile')
        authUrl.searchParams.set('access_type', 'offline')

        window.location.href = authUrl.toString()
      })

      // Xá»­ lÃ½ callback tá»« Google
      const params = new URLSearchParams(window.location.search)
      const code = params.get('code')
      const statusEl = document.getElementById('status')

      if (code) {
        fetch(`${apiBase}/auth/callback`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            code,
            redirect_uri: redirectPath, // Chá»‰ gá»­i path, khÃ´ng gá»­i full URL
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success && data.data?.token) {
              localStorage.setItem('jwt', data.data.token)
              statusEl.textContent = 'âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!'
              window.history.replaceState({}, '', window.location.pathname)
              testApi()
            } else {
              statusEl.textContent =
                'âš ï¸ ' + (data.message || 'ÄÄƒng nháº­p tháº¥t báº¡i')
            }
          })
          .catch((err) => {
            statusEl.textContent = 'âš ï¸ Lá»—i khi Ä‘Äƒng nháº­p: ' + err.message
          })
      }

      // Test gá»i API /api/auth/me náº¿u cÃ³ token
      async function testApi() {
        const token = localStorage.getItem('jwt')
        if (!token) return
        try {
          const res = await fetch(`${apiBase}/auth/me`, {
            headers: { Authorization: `Bearer ${token}` },
          })
          const data = await res.json()
          if (data.success && data.data) {
            statusEl.textContent = `ğŸ‘¤ Xin chÃ o ${
              data.data.name || 'unknown'
            } (${data.data.email})`
          }
        } catch (err) {
          statusEl.textContent = 'âš ï¸ Lá»—i khi gá»i API.'
        }
      }

      testApi()
    </script>
  </body>
</html>
